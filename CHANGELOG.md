# История изменений

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

---

## [Unreleased]

### Added
- Новая структура документации с разделением для администраторов и разработчиков
- Документ `docs/architecture.md` с диаграммами компонентов
- Документ `docs/development/contributing.md` — руководство контрибьютора
- Документ `docs/development/code-style.md` — правила оформления кода
- Документ `docs/technical/log-formats.md` — описание форматов `.lgf` и `.lgd`

### Changed
- Обновлён `README.md` — убрано дублирование, добавлена навигация
- Обновлён `QUICKSTART.md` — добавлена установка для Windows
- Реструктурирован `CHANGELOG.md` с версионированием

---

## [2.0.0] - 2025-12-09

### Added
- Расширенная система мониторинга и логирования
- Веб-панель мониторинга с современным дизайном (Material Design)
- JSON API на `/stats_api` для интеграции с Prometheus, Zabbix, Grafana
- Статистика в реальном времени (`g.stats`)
- Автоматическое создание БД и таблиц в ClickHouse
- Максимальное сжатие данных в ClickHouse (кодек ZSTD)
- Детальное логирование отправки в ClickHouse/Solr с временем выполнения
- Счётчики успешных отправок и ошибок
- Блок "Последние ошибки" на веб-панели

### Changed
- Оптимизирована структура SQLite: составной ключ `(database_name, file_basename)`
- Улучшено логирование: добавлены символы ✓/✗ для успеха/ошибок
- `StateManager` API: добавлен обязательный параметр `database_name`
- Изменён формат хранения состояния файлов (автоматическая миграция)

### Fixed
- **Критическое:** Исправлена опечатка `os._exists()` → `os.path.exists()` (Nikita.py:359)
- **Критическое:** Исправлена утечка ресурсов SQLite в `tools.py` (connection не закрывался)
- **Безопасность:** Устранена SQL Injection уязвимость (параметризация запросов)
- **Безопасность:** Добавлена потокобезопасность для `g.parser.ibases` (threading.Lock)
- **Безопасность:** Потокобезопасное логирование в `tools.py`
- Исправлен race condition в `parser.py` (использование `self.i_` как временной переменной)
- Исправлено неправильное использование `str.find()` в Nikita.py:424
- Исправлено несоответствие типов в `reader.py:161` (возвращался `int` вместо `str`)
- Исправлен маппинг статусов транзакций в `reader.trans_id()` согласно документации 1С

### Removed
- Удалена избыточная логика инверсии статусов транзакций в `fix_act_tran()`

---

## [1.5.0] - 2025-12-05

### Added
- Поддержка автоматического детекта баз 1С через `C1_SRVINFO_PATH`
- Опциональная буферизация через Redis
- Поддержка формата `.lgd` (SQLite)

### Changed
- Улучшена производительность чтения больших лог-файлов (использование `deque`)
- Убраны избыточные вызовы `read_ib_dictionary` из основного цикла парсера

### Fixed
- Оптимизировано чтение последних N строк в `cherry.py` (замена `readlines()` на `deque`)

---

## [1.0.0] - 2025-01-01

### Added
- Первый публичный релиз
- Многопоточный парсинг журналов 1С
- Поддержка экспорта в ClickHouse
- Поддержка экспорта в Solr (опционально)
- Веб-сервер мониторинга (CherryPy)
- Работа как Windows Service
- Работа как Linux daemon (systemd)
- Базовое логирование в каталог `debug/`

---

## Легенда типов изменений

- **Added** — новая функциональность
- **Changed** — изменения в существующей функциональности
- **Deprecated** — функциональность, которая скоро будет удалена
- **Removed** — удалённая функциональность
- **Fixed** — исправления багов
- **Security** — исправления уязвимостей

---

## Миграция между версиями

### 2.0.0 → 2.x.x

**Внимание:** Версия 2.0.0 включает breaking changes в API `StateManager`.

**Изменения:**
- Добавлен обязательный параметр `database_name` в методы:
  - `get_file_state(filename, database_name)`
  - `update_file_state(filename, filesize, filesizeread, database_name)`
  - `log_committed_block(filename, offset_start, offset_end, data_records, database_name)`

**Автоматическая миграция:**
- При первом запуске 2.0.0 автоматически мигрирует старую структуру SQLite
- Для старых записей без `database_name` будет установлено значение `'unknown'`
- Миграция логируется в `debug/Nikita.*.log`

**Действия при обновлении:**
1. Остановите службу: `sudo systemctl stop Nikita` (Linux) или `net stop Nikita` (Windows)
2. Сделайте резервную копию: `cp Nikita.parser.state.db Nikita.parser.state.db.backup`
3. Обновите код: `git pull`
4. Запустите службу: `sudo systemctl start Nikita`
5. Проверьте логи на наличие сообщений о миграции

### 1.x.x → 2.0.0

**Новые возможности:**
- Веб-панель мониторинга доступна на `http://localhost:8984/`
- JSON API для интеграции с системами мониторинга

**Изменения конфигурации:**
- Параметр `CLICKHOUSE_ENABLED` теперь по умолчанию `false` (требуется явное включение)

**Рекомендации:**
1. Добавьте в `.env`: `CLICKHOUSE_ENABLED=true` (если используете ClickHouse)
2. Настройте порт веб-панели: `HTTP_LISTEN_PORT=8984`

---

**Формат документа:** [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/)  
**Версионирование:** [Semantic Versioning](https://semver.org/lang/ru/)
