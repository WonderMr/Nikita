# Форматы журналов 1С:Предприятие

Техническая документация по форматам журналов регистрации `.lgf` (текстовый) и `.lgd` (SQLite).

---

## Содержание

- [Обзор](#обзор)
- [Формат LGF (текстовый)](#формат-lgf-текстовый)
- [Формат LGD (SQLite)](#формат-lgd-sqllite)
- [Сравнение форматов](#сравнение-форматов)
- [Парсинг в Nikita](#парсинг-в-nikita)

---

## Обзор

1С:Предприятие поддерживает два формата журналов регистрации:

### LGF — старый текстовый формат

- **Файлы:** `YYYYMMDD.lgp` (текстовые файлы)
- **Версии 1С:** До 8.3.12
- **Структура:** Построчный текст с фиксированной структурой
- **Кодировка:** UTF-8 или UTF-16 (зависит от настроек)

### LGD — новый формат на базе SQLite

- **Файлы:** `1Cv8.lgd` (SQLite база данных)
- **Версии 1С:** 8.3.12 и выше
- **Структура:** Реляционная БД с таблицами
- **Преимущества:** Быстрее, структурированнее, меньше места

---

## Формат LGF (текстовый)

### Структура файла

Файл состоит из строк, каждая строка — одно событие.

**Формат строки:**
```
ММ:СС.мммммм-П,НТ,УД,Процесс,ТС,Соединение,Событие,Уровень,Комментарий[,Метаданные,Данные,ПредставлениеДанных,РабочийСервер,ОсновнойПорт,ВспомогательныйПорт,Сеанс]
```

**Расшифровка полей:**

| Поле | Описание | Пример |
|------|----------|--------|
| ММ:СС.мммммм | Время (минуты:секунды.микросекунды) | `15:42.123456` |
| П | Длительность (микросекунды) | `0`, `1234` |
| НТ | Статус транзакции | `N`, `C`, `R`, `U` |
| УД | UUID пользователя | `{uuid}` или пусто |
| Процесс | Имя процесса | `rphost`, `1cv8` |
| ТС | Статус транзакции (текст) | ``, `Зафиксирована` |
| Соединение | Номер соединения | `12345` |
| Событие | Тип события | `Выполнение запроса`, `_$Session$_.Start` |
| Уровень | Уровень важности | `Информация`, `Ошибка`, `Предупреждение` |
| Комментарий | Текст комментария | Произвольный текст |

**Опциональные поля** (могут отсутствовать):
- Метаданные (UUID объекта метаданных)
- Данные (дополнительные данные)
- ПредставлениеДанных (текстовое представление)
- РабочийСервер (имя сервера)
- ОсновнойПорт, ВспомогательныйПорт
- Сеанс (номер сеанса)

### Пример события

```
15:42.123456-0,N,{uuid},rphost,,12345,_$Session$_.Start,Информация,Сеанс начат
```

**Расшифровка:**
- Время: 15 мин 42 сек
- Транзакция: N (нет транзакции)
- Пользователь: {uuid}
- Процесс: rphost
- Событие: Начало сеанса
- Уровень: Информация
- Комментарий: "Сеанс начат"

### Парсинг LGF

**Проблемы:**
- Многострочные комментарии (событие может занимать несколько строк)
- Экранирование спецсимволов
- Переменное количество полей

**Подход Nikita:**
Использует регулярные выражения для парсинга:

```python
# Основное регулярное выражение для события
event_pattern = r'(\d{2}:\d{2}\.\d{6})-(\d+),(.*)'
```

См. `src/globals.py::g.rexp` для полных паттернов.

---

## Формат LGD (SQLite)

### Структура базы данных

Файл `1Cv8.lgd` — это SQLite база данных с несколькими таблицами.

### Основная таблица: `EventLog`

```sql
CREATE TABLE EventLog (
    rowID INTEGER PRIMARY KEY,
    DateTime DATETIME,                -- Дата и время события
    TransactionStatus INTEGER,        -- Статус транзакции (0=N, 1=C, 2=R, 3=U)
    TransactionDate DATETIME,         -- Дата транзакции
    TransactionID INTEGER,            -- ID транзакции
    User BLOB,                        -- UUID пользователя (BLOB)
    UserName TEXT,                    -- Имя пользователя
    Computer TEXT,                    -- Имя компьютера
    Application TEXT,                 -- Приложение
    Connection INTEGER,               -- Номер соединения
    Event TEXT,                       -- Тип события
    Severity INTEGER,                 -- Уровень важности (0-4)
    Comment TEXT,                     -- Комментарий
    Metadata BLOB,                    -- UUID метаданных (BLOB)
    Data TEXT,                        -- Дополнительные данные
    DataPresentation TEXT,            -- Представление данных
    Server TEXT,                      -- Рабочий сервер
    PrimaryPort INTEGER,              -- Основной порт
    SecondaryPort INTEGER,            -- Вспомогательный порт
    Session INTEGER                   -- Номер сеанса
);
```

### Вспомогательные таблицы

**`Users`** — справочник пользователей:
```sql
CREATE TABLE Users (
    rowID INTEGER PRIMARY KEY,
    Name TEXT,
    Uuid BLOB
);
```

**`Computers`** — справочник компьютеров:
```sql
CREATE TABLE Computers (
    rowID INTEGER PRIMARY KEY,
    Name TEXT
);
```

**`Applications`** — справочник приложений
**`Events`** — справочник событий
**`Metadata`** — справочник метаданных
**`Servers`** — справочник серверов

### Маппинг значений

#### TransactionStatus

| Значение | Код | Описание |
|----------|-----|----------|
| 0 | N | Нет транзакции |
| 1 | C | Зафиксирована (Commit) |
| 2 | R | Отменена (Rollback) |
| 3 | U | Не завершена (Unfinished) |

#### Severity (Уровень важности)

| Значение | Описание |
|----------|----------|
| 0 | Неизвестно |
| 1 | Информация |
| 2 | Предупреждение |
| 3 | Ошибка |
| 4 | Примечание |

### Пример запроса

```sql
SELECT 
    DateTime,
    TransactionStatus,
    UserName,
    Event,
    Severity,
    Comment
FROM EventLog
WHERE rowID > ?
ORDER BY rowID
LIMIT 200;
```

### Преимущества LGD

1. **Производительность:** SQL-запросы быстрее парсинга текста
2. **Структурированность:** Чёткая схема данных
3. **Индексы:** SQLite автоматически индексирует
4. **Размер:** Сжатие данных в БД → меньше места на диске
5. **Атомарность:** Транзакционность записи событий

---

## Сравнение форматов

| Параметр | LGF (текстовый) | LGD (SQLite) |
|----------|-----------------|--------------|
| **Версия 1С** | До 8.3.12 | 8.3.12+ |
| **Размер файлов** | Больше (текст) | Меньше (сжатие) |
| **Скорость парсинга** | Медленнее (regex) | Быстрее (SQL) |
| **Структурированность** | Низкая | Высокая |
| **Читаемость человеком** | Высокая (текст) | Низкая (бинарник) |
| **Многострочность** | Есть (проблема) | Нет |
| **Индексы** | Нет | Есть (rowID) |
| **Блокировки** | Файловые | SQLite locks |

**Nikita поддерживает оба формата** автоматически.

---

## Парсинг в Nikita

### Автоопределение формата

При обнаружении базы 1С Nikita определяет формат:

```python
def detect_format(log_directory):
    if os.path.exists(os.path.join(log_directory, "1Cv8.lgd")):
        return "lgd"
    elif glob.glob(os.path.join(log_directory, "*.lgp")):
        return "lgf"
    else:
        return "unknown"
```

### Модуль reader.py

#### Для LGF:

```python
def read_lgp(filename, offset, limit):
    """
    1. Открыть файл на чтение
    2. Seek к offset
    3. Прочитать limit байт
    4. Вернуть текст
    """
    with open(filename, 'r', encoding='utf-8') as f:
        f.seek(offset)
        return f.read(limit)
```

#### Для LGD:

```python
def read_lgd(filename, offset_ids):
    """
    1. Подключиться к SQLite БД
    2. SELECT * FROM EventLog WHERE rowID IN (...)
    3. Преобразовать BLOB → UUID
    4. Вернуть список словарей
    """
    conn = sqlite3.connect(filename)
    cursor = conn.cursor()
    
    placeholders = ','.join('?' * len(offset_ids))
    query = f"SELECT * FROM EventLog WHERE rowID IN ({placeholders})"
    cursor.execute(query, offset_ids)
    
    results = []
    for row in cursor.fetchall():
        results.append({
            'DateTime': row[1],
            'TransactionStatus': map_trans_status(row[2]),
            # ...
        })
    
    return results
```

### Преобразование в единый формат

Nikita преобразует оба формата в единый внутренний формат (словарь Python):

```python
{
    'DateTime': datetime,
    'TransactionStatus': 'N'|'C'|'R'|'U',
    'User': 'uuid-string',
    'Event': 'event-name',
    'Severity': 'Информация'|'Ошибка'|...,
    'Comment': 'text',
    # ...
}
```

Это позволяет единообразно отправлять в ClickHouse/Solr независимо от формата.

---

## Примеры событий

### Начало сеанса

**LGF:**
```
15:42.000000-0,N,,rphost,,12345,_$Session$_.Start,Информация,Сеанс начат
```

**LGD:**
```sql
rowID=1, DateTime='2025-12-11 15:42:00', Event='_$Session$_.Start', Severity=1
```

### Выполнение запроса

**LGF:**
```
15:43.123456-5000,C,{uuid},1cv8,Зафиксирована,12345,DBMSSQL,Информация,SELECT * FROM Catalog
```

**LGD:**
```sql
rowID=2, DateTime='2025-12-11 15:43:00.123456', TransactionStatus=1, Event='DBMSSQL'
```

### Ошибка

**LGF:**
```
15:44.000000-0,N,{uuid},1cv8,,12345,_$Session$_.Exception,Ошибка,"Ошибка при выполнении операции
Деталь ошибки: текст на нескольких строках"
```

**LGD:**
```sql
rowID=3, Severity=3, Comment='Ошибка при выполнении операции...'
```

---

## Дополнительные ресурсы

### Официальная документация 1С

- [Технологическая платформа 8.3 — Журнал регистрации](https://its.1c.ru/db/v8320doc#bookmark:adm:TI000000476)

### Инструменты

- **lgf2lgd** — конвертер LGF → LGD (если нужно)
- **SQLite Browser** — просмотр .lgd файлов

---

**Обновлено:** 2025-12-11  
**Версия:** 2.0.0

