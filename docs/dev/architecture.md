# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Nikita

–û–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∂—É—Ä–Ω–∞–ª–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ.

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±—â–∏–π –æ–±–∑–æ—Ä](#–æ–±—â–∏–π-–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è-–¥–∏–∞–≥—Ä–∞–º–º–∞)
- [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
- [–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö)
- [–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å](#–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å)
- [–•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#—Ö—Ä–∞–Ω–µ–Ω–∏–µ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
- [–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å](#–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å)

---

## –û–±—â–∏–π –æ–±–∑–æ—Ä

Nikita ‚Äî —ç—Ç–æ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π:
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç** –∫–∞—Ç–∞–ª–æ–≥–∏ –∂—É—Ä–Ω–∞–ª–æ–≤ 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ
2. **–ü–∞—Ä—Å–∏—Ç** —Å–æ–±—ã—Ç–∏—è –∏–∑ —Ñ–∞–π–ª–æ–≤ `.lgf` (—Ç–µ–∫—Å—Ç–æ–≤—ã—Ö) –∏ `.lgd` (SQLite)
3. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç** –¥–∞–Ω–Ω—ã–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (ClickHouse, Solr, Redis)
4. **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç** –≤–µ–±-–ø–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ JSON API

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

### –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph c1 [1C Enterprise]
        lgf[".lgf —Ñ–∞–π–ª—ã<br/>(—Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∂—É—Ä–Ω–∞–ª—ã)"]
        lgd[".lgd —Ñ–∞–π–ª—ã<br/>(SQLite –∂—É—Ä–Ω–∞–ª—ã)"]
    end

    subgraph nikita [Nikita Service]
        reader[Reader Module<br/>–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤]
        parser[Parser Module<br/>–ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π]
        state[State Manager<br/>SQLite]
        sender[Sender Module<br/>–û—Ç–ø—Ä–∞–≤–∫–∞ –±–∞—Ç—á–µ–π]
        web[Web Server<br/>CherryPy]
    end

    subgraph storage [Data Storage]
        ch[ClickHouse<br/>–ö–æ–ª–æ–Ω–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ]
        solr[Solr<br/>–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫]
        redis[Redis<br/>–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è]
    end

    subgraph monitoring [Monitoring]
        browser[–í–µ–±-–ø–∞–Ω–µ–ª—å<br/>localhost:8984]
        prom[Prometheus/Zabbix<br/>JSON API]
    end

    lgf --> reader
    lgd --> reader
    reader --> parser
    parser --> state
    parser --> sender
    sender --> ch
    sender --> solr
    sender --> redis
    web --> browser
    web --> prom
    parser --> web
    sender --> web
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ

```mermaid
sequenceDiagram
    participant F as –§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞
    participant R as Reader
    participant P as Parser
    participant SM as State Manager
    participant S as Sender
    participant CH as ClickHouse

    loop –ö–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
        P->>SM: –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–∞
        SM-->>P: (filesize, filesizeread)
        P->>F: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
        
        alt –§–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è
            P->>R: –ü—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            R-->>P: –°—ã—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–æ–±—ã—Ç–∏–π
            P->>P: –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏
            P->>S: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∞—Ç—á (200 –∑–∞–ø–∏—Å–µ–π)
            S->>CH: INSERT INTO —Ç–∞–±–ª–∏—Ü–∞
            CH-->>S: ‚úì OK
            S-->>P: ‚úì –£—Å–ø–µ—à–Ω–æ
            P->>SM: –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            SM-->>P: ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
        end
    end
```

### –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph main [Main Thread]
        service[Service Entry Point]
    end

    subgraph workers [Worker Threads]
        p1[Parser Thread 1<br/>–ë–∞–∑–∞: PROD_ZUP]
        p2[Parser Thread 2<br/>–ë–∞–∑–∞: TEST_UT11]
        p3[Parser Thread 3<br/>–ë–∞–∑–∞: EXTERNAL]
        pn[Parser Thread N<br/>...]
    end

    subgraph shared [Shared Resources]
        conf[g.conf<br/>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è]
        stats[g.stats<br/>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]
        ibases[g.parser.ibases<br/>–°–ø–∏—Å–æ–∫ –±–∞–∑<br/>+ threading.Lock]
        statemgr[State Manager<br/>SQLite + Lock]
    end

    subgraph httpserver [HTTP Server Thread]
        cherry[CherryPy<br/>:8984]
    end

    service --> p1
    service --> p2
    service --> p3
    service --> pn
    service --> cherry

    p1 --> conf
    p2 --> conf
    p3 --> conf
    pn --> conf

    p1 --> stats
    p2 --> stats
    p3 --> stats
    pn --> stats

    p1 --> ibases
    p2 --> ibases
    p3 --> ibases
    pn --> ibases

    p1 --> statemgr
    p2 --> statemgr
    p3 --> statemgr
    pn --> statemgr

    cherry --> stats
    cherry --> ibases
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Entry Point (`Nikita.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å–ª—É–∂–±—ã.

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `start_all()` ‚Äî –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- `stop_all()` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤
- `nikita_service` (Windows) ‚Äî –∫–ª–∞—Å—Å Windows Service
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ (Linux daemon)

**–†–µ–∂–∏–º—ã –∑–∞–ø—É—Å–∫–∞:**
```bash
python Nikita.py console   # –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–æ—Ç–ª–∞–¥–∫–∞)
python Nikita.py install   # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É–∂–±—ã (Windows)
python Nikita.py start     # –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã (Windows)
python Nikita.py stop      # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É–∂–±—ã (Windows)
python Nikita.py remove    # –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª—É–∂–±—ã (Windows)
```

### 2. Globals (`src/globals.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

**–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:**
- `g.conf` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ `.env`
- `g.stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- `g.parser` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞
- `g.rexp` ‚Äî —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- `g.ibases_lock` ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from src import globals as g

# –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
clickhouse_host = g.conf.clickhouse_host

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
g.stats.clickhouse_total_sent += 200

# –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–ø–∏—Å–∫—É –±–∞–∑
with g.ibases_lock:
    bases = g.parser.ibases.copy()
```

### 3. Reader (`src/reader.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∂—É—Ä–Ω–∞–ª–æ–≤ (`.lgf` –∏ `.lgd`).

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `reader.read_lgp()` ‚Äî —á—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∂—É—Ä–Ω–∞–ª–æ–≤ `.lgf`
- `reader.read_lgd()` ‚Äî —á—Ç–µ–Ω–∏–µ SQLite –∂—É—Ä–Ω–∞–ª–æ–≤ `.lgd`
- `reader.trans_id()` ‚Äî –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–§–æ—Ä–º–∞—Ç—ã:**
- **LGF** ‚Äî —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (–ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
- **LGD** ‚Äî SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQL-–∑–∞–ø—Ä–æ—Å—ã)

### 4. Parser (`src/parser.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏.

**–ö–ª—é—á–µ–≤—ã–µ –∫–ª–∞—Å—Å—ã:**
- `lgp_parser_thread` ‚Äî –ø–æ—Ç–æ–∫ –ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è –æ–¥–Ω–æ–π –±–∞–∑—ã 1–°

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `run()` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø–æ—Ç–æ–∫–∞
- `post_query()` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–∞—Ç—á–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- `send_to_clickhouse()` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ ClickHouse
- `send_to_solr()` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Solr
- `read_ib_dictionary()` ‚Äî —á—Ç–µ–Ω–∏–µ —Å–ª–æ–≤–∞—Ä–µ–π 1–°

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:**
1. –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ State Manager
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
3. –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Reader
4. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å–æ–±—ã—Ç–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏
5. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –±–∞—Ç—á (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 200 –∑–∞–ø–∏—Å–µ–π)
6. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Sender
7. –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ State Manager
8. –ü–æ–≤—Ç–æ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥

### 5. State Manager (`src/state_manager.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ SQLite.

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** `Nikita.parser.state.db`

**–¢–∞–±–ª–∏—Ü—ã:**
- `file_states` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (—Ä–∞–∑–º–µ—Ä, –ø—Ä–æ—á–∏—Ç–∞–Ω–æ)
- `committed_blocks` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `get_file_state(filename, database_name)` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–∞
- `update_file_state(...)` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `log_committed_block(...)` ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫
- `get_total_records_sent(database_name)` ‚Äî —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø–∏—Å–µ–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ file_states:**
```sql
CREATE TABLE file_states (
    database_name TEXT,
    file_basename TEXT,
    filesize INTEGER,
    filesizeread INTEGER,
    PRIMARY KEY (database_name, file_basename)
);
```

### 6. Sender (`src/sender.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `send_to_clickhouse()` ‚Äî –≤—Å—Ç–∞–≤–∫–∞ –≤ ClickHouse
- `send_to_solr()` ‚Äî –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Solr
- `send_to_redis()` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å Redis

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ë–∞—Ç—á–µ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 200 –∑–∞–ø–∏—Å–µ–π)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ ClickHouse
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 7. Web Server (`src/cherry.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** HTTP-—Å–µ—Ä–≤–µ—Ä –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (CherryPy).

**Endpoints:**
- `GET /` ‚Äî –≤–µ–±-–ø–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (HTML)
- `GET /stats_api` ‚Äî JSON API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–î–∞–Ω–Ω—ã–µ –Ω–∞ –ø–∞–Ω–µ–ª–∏:**
- Uptime —Å–ª—É–∂–±—ã
- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (üü¢/üî¥)
- –°—á—ë—Ç—á–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏
- –°–ø–∏—Å–æ–∫ –±–∞–∑ 1–° —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º

### 8. Tools (`src/tools.py`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `debug_print()` ‚Äî –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- `sqlite3_exec()` ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
- `strtobool()` ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è

```mermaid
flowchart TD
    Start([–ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞]) --> CheckState
    CheckState[–ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ SQLite]
    CheckState --> CheckSize[–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞]
    
    CheckSize --> Changed{–§–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è?}
    Changed -->|–ù–µ—Ç| Sleep[–û–∂–∏–¥–∞–Ω–∏–µ N —Å–µ–∫]
    Sleep --> CheckState
    
    Changed -->|–î–∞| ReadData[–ü—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ]
    ReadData --> ParseRegex[–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏]
    ParseRegex --> Batch{–ù–∞–±—Ä–∞–Ω–æ 200 –∑–∞–ø–∏—Å–µ–π?}
    
    Batch -->|–ù–µ—Ç| Continue[–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ]
    Continue --> ParseRegex
    
    Batch -->|–î–∞| SendBatch[–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∞—Ç—á]
    SendBatch --> CH{ClickHouse –≤–∫–ª—é—á–µ–Ω?}
    
    CH -->|–î–∞| SendCH[INSERT –≤ ClickHouse]
    SendCH --> CHResult{–£—Å–ø–µ—Ö?}
    CHResult -->|–î–∞| UpdateStats1[–û–±–Ω–æ–≤–∏—Ç—å g.stats]
    CHResult -->|–ù–µ—Ç| LogError1[–ó–∞–ø–∏—Å–∞—Ç—å –æ—à–∏–±–∫—É]
    
    CH -->|–ù–µ—Ç| Solr
    UpdateStats1 --> Solr
    LogError1 --> Solr
    
    Solr{Solr –≤–∫–ª—é—á–µ–Ω?}
    Solr -->|–î–∞| SendSolr[POST –≤ Solr]
    SendSolr --> SolrResult{–£—Å–ø–µ—Ö?}
    SolrResult -->|–î–∞| UpdateStats2[–û–±–Ω–æ–≤–∏—Ç—å g.stats]
    SolrResult -->|–ù–µ—Ç| LogError2[–ó–∞–ø–∏—Å–∞—Ç—å –æ—à–∏–±–∫—É]
    
    Solr -->|–ù–µ—Ç| UpdateState
    UpdateStats2 --> UpdateState
    LogError2 --> UpdateState
    
    UpdateState[–û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ SQLite]
    UpdateState --> CheckState
```

---

## –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å

### –ú–æ–¥–µ–ª—å –ø–æ—Ç–æ–∫–æ–≤

Nikita –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å** —Å –ø–æ—Ç–æ–∫–æ–º –Ω–∞ –∫–∞–∂–¥—É—é –±–∞–∑—É 1–°:

```python
# –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä
for –±–∞–∑–∞ in —Å–ø–∏—Å–æ–∫_–±–∞–∑:
    –ø–æ—Ç–æ–∫ = Thread(target=–ø–∞—Ä—Å–µ—Ä_—Ñ—É–Ω–∫—Ü–∏—è, args=(–±–∞–∑–∞,))
    –ø–æ—Ç–æ–∫.start()
```

### –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –æ–±—â–∏–º –¥–∞–Ω–Ω—ã–º.

**–†–µ—à–µ–Ω–∏–µ:**
1. **threading.Lock** –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π
2. **SQLite** —Å –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º WAL
3. **–ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ** (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)

**–ü—Ä–∏–º–µ—Ä—ã:**

```python
# 1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –±–∞–∑
with g.ibases_lock:
    bases = g.parser.ibases.copy()

# 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
with tools.log_lock:
    file.write(message)

# 3. State Manager –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Lock
state_manager.update_file_state(...)  # –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ
```

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ:**
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ 1 –ø–æ—Ç–æ–∫—É –Ω–∞ –±–∞–∑—É 1–°
- –ï—Å–ª–∏ –±–∞–∑ –±–æ–ª—å—à–µ, —á–µ–º —è–¥–µ—Ä CPU ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ 1 –ø–æ—Ç–æ–∫—É –Ω–∞ –±–∞–∑—É
- –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

**–†—É—á–Ω–æ–µ:**
```ini
# .env
PARSER_THREADS=4  # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å 4 –ø–æ—Ç–æ–∫–∞–º–∏
```

---

## –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### SQLite State Database

**–§–∞–π–ª:** `Nikita.parser.state.db`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –ó–∞–ø–æ–º–Ω–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
- –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- –ò–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–°—Ö–µ–º–∞:**

```sql
-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
CREATE TABLE file_states (
    database_name TEXT NOT NULL,     -- –ò–º—è –±–∞–∑—ã 1–°
    file_basename TEXT NOT NULL,     -- –ò–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ –ø—É—Ç–∏)
    filesize INTEGER,                -- –ü–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    filesizeread INTEGER,            -- –°–∫–æ–ª—å–∫–æ —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
    PRIMARY KEY (database_name, file_basename)
);

-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤
CREATE TABLE committed_blocks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    database_name TEXT,
    file_basename TEXT,
    offset_start INTEGER,
    offset_end INTEGER,
    data_records INTEGER,
    committed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```python
state = state_manager.get_file_state("/path/to/file.lgp", "–ë–∞–∑–∞1")
# {'filesize': 1000000, 'filesizeread': 500000}

# –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —á—Ç–µ–Ω–∏–µ —Å –ø–æ–∑–∏—Ü–∏–∏ 500000
```

### –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å –≤–µ—Ä—Å–∏–∏ 1.x ‚Üí 2.0:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ `debug/Nikita.*.log`

---

## –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:**

1. **CPU:**
   - –£–≤–µ–ª–∏—á—å—Ç–µ `PARSER_THREADS` –≤ `.env`
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –ø–æ 1 –ø–æ—Ç–æ–∫—É –Ω–∞ –±–∞–∑—É 1–°

2. **–ü–∞–º—è—Ç—å:**
   - –£–≤–µ–ª–∏—á—å—Ç–µ `SOLR_MEM_MAX` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Solr)
   - Nikita —Å–∞–º –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç ~200-500 MB

3. **–î–∏—Å–∫:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSD –¥–ª—è –∂—É—Ä–Ω–∞–ª–æ–≤ 1–°
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSD –¥–ª—è ClickHouse

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ù–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ Nikita:**

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –£ –≤–∞—Å 100 –±–∞–∑ 1–°, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –ø–æ —Ä–∞–∑–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Nikita –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å 1–°
2. –í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≤ –æ–¥–∏–Ω ClickHouse –∫–ª–∞—Å—Ç–µ—Ä
3. –ö–∞–∂–¥—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–≤–æ–∏ –±–∞–∑—ã

**–ü—Ä–∏–º–µ—Ä:**
```
–°–µ—Ä–≤–µ—Ä 1C ‚Ññ1 (20 –±–∞–∑) ‚Üí Nikita ‚Ññ1 ‚îÄ‚îê
–°–µ—Ä–≤–µ—Ä 1C ‚Ññ2 (30 –±–∞–∑) ‚Üí Nikita ‚Ññ2 ‚îÄ‚îº‚Üí ClickHouse –∫–ª–∞—Å—Ç–µ—Ä
–°–µ—Ä–≤–µ—Ä 1C ‚Ññ3 (50 –±–∞–∑) ‚Üí Nikita ‚Ññ3 ‚îÄ‚îò
```

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ClickHouse

–î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä ClickHouse:
- **Sharding** ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º
- **Replication** ‚Äî —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
- **Distributed —Ç–∞–±–ª–∏—Ü—ã** ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –¥–æ—Å—Ç—É–ø

–°–º. [ClickHouse Documentation](https://clickhouse.com/docs/ru/engines/table-engines/special/distributed)

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –¢–∏–ø–∏—á–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

**–ñ–µ–ª–µ–∑–æ:** 4 CPU cores, 8 GB RAM, SSD

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –ë–∞–∑ 1–° | 10 |
| –°–æ–±—ã—Ç–∏—è/—Å–µ–∫ | 1000-5000 |
| –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ | <50ms (–ª–æ–∫–∞–ª—å–Ω—ã–π ClickHouse) |
| –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ CPU | 10-30% |
| –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ RAM | 200-500 MB |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.lgd` –≤–º–µ—Å—Ç–æ `.lgf`** ‚Äî SQLite –±—ã—Å—Ç—Ä–µ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
2. **–õ–æ–∫–∞–ª—å–Ω—ã–π ClickHouse** ‚Äî –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
3. **SSD –¥–∏—Å–∫–∏** ‚Äî –±—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–æ–≤
4. **–û—Ç–∫–ª—é—á–∏—Ç–µ Solr** ‚Äî –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis** ‚Äî –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è

```mermaid
graph TB
    subgraph server1c [1C Server]
        c1app[1C:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ]
        logs[–ñ—É—Ä–Ω–∞–ª—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏]
    end

    subgraph appserver [Application Server]
        nikita[Nikita Service]
    end

    subgraph dbserver [Database Server]
        ch[ClickHouse]
    end

    subgraph optional [Optional Services]
        solr[Solr Server]
        redis[Redis Server]
    end

    c1app --> logs
    logs --> nikita
    nikita --> ch
    nikita -.-> solr
    nikita -.-> redis
```

---

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-12-11  
**–í–µ—Ä—Å–∏—è:** 2.0.0

